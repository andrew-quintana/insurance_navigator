-- 20251001T000000_add_storage_buckets_rls_policies.sql
-- Add missing RLS policies for storage.buckets table
-- This fixes the "Bucket not found" error when workers try to list objects
-- Based on FM-027 investigation findings

BEGIN;

-- Add RLS policies for storage.buckets table
-- This fixes the "Bucket not found" error when listing objects

-- Allow service role to view buckets
CREATE POLICY "Allow service role to view buckets"
ON storage.buckets
FOR SELECT
TO service_role
USING (true);

-- Allow service role to manage buckets
CREATE POLICY "Allow service role to manage buckets"
ON storage.buckets
FOR ALL
TO service_role
USING (true)
WITH CHECK (true);

-- Verify the policies were created
DO $$
BEGIN
    -- Check bucket view policy
    IF NOT EXISTS (
        SELECT 1 FROM pg_policies 
        WHERE tablename = 'buckets' 
        AND schemaname = 'storage'
        AND policyname = 'Allow service role to view buckets'
    ) THEN
        RAISE EXCEPTION 'Bucket view policy was not created successfully';
    END IF;
    
    -- Check bucket management policy
    IF NOT EXISTS (
        SELECT 1 FROM pg_policies 
        WHERE tablename = 'buckets' 
        AND schemaname = 'storage'
        AND policyname = 'Allow service role to manage buckets'
    ) THEN
        RAISE EXCEPTION 'Bucket management policy was not created successfully';
    END IF;
    
    RAISE NOTICE 'All storage.buckets RLS policies created successfully';
END $$;

COMMIT;
