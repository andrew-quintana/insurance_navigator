#!/usr/bin/env python3
"""
Complete Development Workflow Test

This test validates the complete development workflow with separated requirements:
1. API Service functionality
2. Worker functionality  
3. Upload pipeline functionality
4. RAG retrieval and generation
5. Database connectivity
6. Agent orchestration
"""

import os
import sys
import asyncio
import logging
from typing import Dict, Any

# Set up logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

def test_environment_setup():
    """Test environment setup and configuration."""
    print("üîç Testing Environment Setup")
    print("=" * 50)
    
    try:
        # Test environment variables
        from dotenv import load_dotenv
        load_dotenv()
        
        # Test configuration
        from config.configuration_manager import get_config_manager
        config = get_config_manager()
        
        print(f"‚úÖ Environment: {config.environment}")
        print(f"‚úÖ Database URL configured: {bool(getattr(config, 'database_url', None))}")
        print(f"‚úÖ OpenAI API key configured: {bool(getattr(config, 'openai_api_key', None))}")
        print(f"‚úÖ Supabase URL configured: {bool(getattr(config, 'supabase_url', None))}")
        
        return True
        
    except Exception as e:
        print(f"‚ùå Environment setup failed: {e}")
        return False

def test_database_connectivity():
    """Test database connectivity."""
    print("\nüîç Testing Database Connectivity")
    print("=" * 50)
    
    try:
        # Test database configuration
        from config.database import get_database_url, get_db_config
        db_url = get_database_url()
        db_config = get_db_config()
        
        print(f"‚úÖ Database URL: {db_url[:50]}...")
        print(f"‚úÖ Database config loaded successfully")
        
        # Test database manager
        from core.database import get_database_manager
        print("‚úÖ Database manager imports successful")
        
        return True
        
    except Exception as e:
        print(f"‚ùå Database connectivity test failed: {e}")
        return False

def test_api_service_core():
    """Test API service core functionality."""
    print("\nüîç Testing API Service Core")
    print("=" * 50)
    
    try:
        # Test main app
        from main import app
        print(f"‚úÖ Main app loaded with {len(app.router.routes)} routes")
        
        # Test core modules
        from core import initialize_system, close_system
        print("‚úÖ Core system imports successful")
        
        # Test service manager
        from core.service_manager import get_service_manager
        print("‚úÖ Service manager imports successful")
        
        # Test agent integration
        from core.agent_integration import AgentIntegrationManager
        print("‚úÖ Agent integration imports successful")
        
        return True
        
    except Exception as e:
        print(f"‚ùå API service core test failed: {e}")
        return False

def test_agent_system():
    """Test agent system functionality."""
    print("\nüîç Testing Agent System")
    print("=" * 50)
    
    try:
        # Test patient navigator agents
        from agents.patient_navigator.supervisor.workflow import SupervisorWorkflow
        from agents.patient_navigator.supervisor.workflow_prescription.agent import WorkflowPrescriptionAgent
        from agents.patient_navigator.supervisor.document_availability import DocumentAvailabilityChecker
        
        print("‚úÖ Patient navigator agents imports successful")
        
        # Test RAG system
        from agents.tooling.rag.core import RAGTool, RetrievalConfig
        from agents.tooling.rag.observability import RAGPerformanceMonitor
        
        print("‚úÖ RAG system imports successful")
        
        # Test agent workflow creation
        workflow = SupervisorWorkflow(use_mock=True)
        print("‚úÖ Agent workflow creation successful")
        
        return True
        
    except Exception as e:
        print(f"‚ùå Agent system test failed: {e}")
        return False

def test_upload_pipeline():
    """Test upload pipeline functionality."""
    print("\nüîç Testing Upload Pipeline")
    print("=" * 50)
    
    try:
        # Test upload pipeline modules
        from api.upload_pipeline.database import get_database, DatabaseManager
        from api.upload_pipeline.webhooks import router as webhook_router
        from api.upload_pipeline.endpoints.upload import router as upload_router
        
        print("‚úÖ Upload pipeline modules imports successful")
        
        # Test database manager creation
        db_manager = DatabaseManager()
        print("‚úÖ Upload pipeline database manager creation successful")
        
        return True
        
    except Exception as e:
        print(f"‚ùå Upload pipeline test failed: {e}")
        return False

def test_rag_functionality():
    """Test RAG functionality."""
    print("\nüîç Testing RAG Functionality")
    print("=" * 50)
    
    try:
        # Test RAG tool
        from agents.tooling.rag.core import RAGTool, RetrievalConfig
        
        # Create test configuration
        config = RetrievalConfig(
            similarity_threshold=0.3,
            max_chunks=5,
            token_budget=2000
        )
        
        print("‚úÖ RAG tool configuration successful")
        
        # Test RAG observability
        from agents.tooling.rag.observability import RAGPerformanceMonitor, threshold_manager
        print("‚úÖ RAG observability imports successful")
        
        return True
        
    except Exception as e:
        print(f"‚ùå RAG functionality test failed: {e}")
        return False

def test_worker_functionality():
    """Test worker functionality."""
    print("\nüîç Testing Worker Functionality")
    print("=" * 50)
    
    try:
        # Test worker modules
        from backend.workers.enhanced_base_worker import EnhancedBaseWorker
        from backend.workers.enhanced_runner import EnhancedWorkerRunner
        
        print("‚úÖ Worker modules imports successful")
        
        # Test external services
        from bs4 import BeautifulSoup
        from duckduckgo_search import DDGS
        import wikipedia
        import pandas as pd
        import numpy as np
        
        print("‚úÖ External services imports successful")
        
        return True
        
    except Exception as e:
        print(f"‚ùå Worker functionality test failed: {e}")
        return False

def test_security_system():
    """Test security system functionality."""
    print("\nüîç Testing Security System")
    print("=" * 50)
    
    try:
        # Test authentication
        from db.services.auth_adapter import auth_adapter
        print(f"‚úÖ Auth adapter: {getattr(auth_adapter, 'backend_name', 'MINIMAL')}")
        
        # Test security imports
        from jose import jwt
        from passlib.context import CryptContext
        import bcrypt
        
        print("‚úÖ Security modules imports successful")
        
        return True
        
    except Exception as e:
        print(f"‚ùå Security system test failed: {e}")
        return False

def test_external_services():
    """Test external services connectivity."""
    print("\nüîç Testing External Services")
    print("=" * 50)
    
    try:
        # Test OpenAI
        import openai
        print("‚úÖ OpenAI client imports successful")
        
        # Test Supabase
        from supabase import create_client, Client
        print("‚úÖ Supabase client imports successful")
        
        # Test HTTP clients
        import aiohttp
        import requests
        import httpx
        
        print("‚úÖ HTTP clients imports successful")
        
        return True
        
    except Exception as e:
        print(f"‚ùå External services test failed: {e}")
        return False

async def test_async_workflow():
    """Test async workflow functionality."""
    print("\nüîç Testing Async Workflow")
    print("=" * 50)
    
    try:
        # Test async database operations
        from core.database import get_database_manager
        
        # Test async agent integration
        from core.agent_integration import initialize_agent_integration
        
        print("‚úÖ Async workflow imports successful")
        
        return True
        
    except Exception as e:
        print(f"‚ùå Async workflow test failed: {e}")
        return False

def test_requirements_validation():
    """Test that requirements are properly separated."""
    print("\nüîç Testing Requirements Validation")
    print("=" * 50)
    
    try:
        # Test that sentence-transformers is NOT available (should be in testing only)
        try:
            import sentence_transformers
            print("‚ö†Ô∏è  sentence-transformers is available (should only be in testing)")
            return False
        except ImportError:
            print("‚úÖ sentence-transformers not available (correct for API/worker)")
        
        # Test that core dependencies are available
        import fastapi
        import pydantic
        import asyncpg
        import openai
        import langchain
        import langgraph
        
        print("‚úÖ Core dependencies available")
        
        return True
        
    except Exception as e:
        print(f"‚ùå Requirements validation failed: {e}")
        return False

def main():
    """Run complete workflow test."""
    print("üöÄ COMPLETE DEVELOPMENT WORKFLOW TEST")
    print("=" * 60)
    print("Testing separated requirements and complete functionality")
    print("=" * 60)
    
    tests = [
        ("Environment Setup", test_environment_setup),
        ("Database Connectivity", test_database_connectivity),
        ("API Service Core", test_api_service_core),
        ("Agent System", test_agent_system),
        ("Upload Pipeline", test_upload_pipeline),
        ("RAG Functionality", test_rag_functionality),
        ("Worker Functionality", test_worker_functionality),
        ("Security System", test_security_system),
        ("External Services", test_external_services),
        ("Async Workflow", lambda: asyncio.run(test_async_workflow())),
        ("Requirements Validation", test_requirements_validation),
    ]
    
    results = {}
    
    for test_name, test_func in tests:
        try:
            result = test_func()
            results[test_name] = result
        except Exception as e:
            print(f"‚ùå {test_name} failed with exception: {e}")
            results[test_name] = False
    
    print("\n" + "=" * 60)
    print("üìä COMPLETE WORKFLOW TEST SUMMARY")
    print("=" * 60)
    
    passed = sum(1 for result in results.values() if result)
    total = len(results)
    
    for test_name, result in results.items():
        status = "‚úÖ PASS" if result else "‚ùå FAIL"
        print(f"{status} {test_name}")
    
    print(f"\nOverall: {passed}/{total} tests passed")
    
    if passed == total:
        print("üéâ Complete workflow test passed! All systems are working correctly.")
        print("‚úÖ API service requirements are complete and functional")
        print("‚úÖ Worker service requirements are complete and functional")
        print("‚úÖ Requirements separation is working correctly")
        print("‚úÖ All core functionality is operational")
        return True
    else:
        print("‚ö†Ô∏è  Some workflow tests failed. Check the issues above.")
        return False

if __name__ == "__main__":
    success = main()
    sys.exit(0 if success else 1)
