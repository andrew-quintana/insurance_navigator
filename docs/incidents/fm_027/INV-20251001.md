# INV-20251001: FM-027 Document Processing Failure Investigation

## Changelog
- **2025-10-01 03:30 UTC**: Initial investigation document created
- **2025-10-01 03:30 UTC**: Root cause identified: StorageManager URL construction bug
- **2025-10-01 03:30 UTC**: Critical fix deployed (commit 33c0384)
- **2025-10-01 03:30 UTC**: Path mismatch investigation ongoing

## 1. Executive Snapshot

**Symptom**: Document processing failures with error "Document file is not accessible for processing. Please try uploading again." occurring in the Insurance Navigator upload pipeline after successful file uploads.

**Impact**: High severity - complete document processing pipeline failure affecting all users attempting to upload and process insurance documents. Users can upload files successfully but processing fails with user-facing error messages, rendering the core RAG functionality non-operational.

**Current Status**: 
- **Reproduced**: ‚úÖ Yes - consistently reproducible in staging environment
- **Containment in place**: ‚úÖ Yes - critical StorageManager bug fixed and deployed (commit 33c0384)
- **Remaining issues**: Path mismatch between generated and actual file paths needs investigation

## 2. Signal & Scope

### Exact Error Text
```
"error": "Non-retryable error: user_facing_error: Document file is not accessible for processing. Please try uploading again. (Reference: d00dd99c-a874-4b86-98f3-b73dc1ec3dc4)"
```

### Error Context
- **Service**: Upload Pipeline Worker (staging)
- **Job ID**: d51e51cc-bf64-4aa0-ab4b-4416683dae82
- **Document ID**: 2f064818-4568-5ca2-ad05-e26484d8f1c4
- **Status**: failed_parse
- **Retry Count**: 0
- **Created**: 2025-10-01 03:23:10.136219+00
- **Updated**: 2025-10-01 03:23:21.534038+00

### Affected Services/Paths
- **Primary**: `backend/workers/enhanced_base_worker.py` - `_direct_llamaparse_call()`
- **Secondary**: `backend/shared/storage/storage_manager.py` - `blob_exists()` and `read_blob()`
- **API**: `api/upload_pipeline/endpoints/upload.py` - file upload and job creation
- **Storage**: Supabase Storage bucket `files`

### SLO/SLA Impacts
- **Document Processing Success Rate**: 0% (complete failure)
- **User Experience**: Severe degradation - core functionality unavailable
- **Data Integrity**: No data loss, but processing pipeline completely broken

### "Spelling Mode" Definition
**Status**: Not applicable - No "spelling mode" functionality found in codebase. Search revealed only standard dictionary operations and Levenshtein distance algorithms for text processing, not related to this storage access issue.

## 3. Minimal Repro & Variants

### Minimal Reproduction Script
```bash
# Environment setup
cd /Users/aq_home/1Projects/accessa/insurance_navigator
export SUPABASE_URL="https://dfgzeastcxnoqshgyotp.supabase.co"
export ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
export SUPABASE_SERVICE_ROLE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."

# Run reproduction test
python test_storage_manager_debug.py
```

### Environment Matrix
| Environment | OS | Runtime | Supabase | Status |
|-------------|----|---------|---------|---------| 
| Staging | Linux | Python 3.11 | dfgzeastcxnoqshgyotp | ‚úÖ Reproduces |
| Local | macOS | Python 3.11 | dfgzeastcxnoqshgyotp | ‚úÖ Reproduces |
| Production | Linux | Python 3.11 | dfgzeastcxnoqshgyotp | ‚ùì Unknown |

### Test Scripts Created
- `test_storage_manager_debug.py` - StorageManager URL construction debugging
- `test_complete_flow_simulation.py` - End-to-end flow simulation
- `test_actual_file_access.py` - Direct HTTP file access testing
- `test_list_storage_files.py` - Storage bucket enumeration

## 4. Timeline & Change Diff

### Last Known Good
- **Date**: Before 2025-09-30 23:46 UTC
- **Evidence**: No reported issues in previous investigation materials
- **State**: Document processing working normally

### First Bad
- **Date**: 2025-09-30 23:46 UTC
- **Evidence**: First error reported in FM-027 investigation
- **State**: "Document file is not accessible" errors begin

### Causal Diff Analysis
**Critical Discovery**: The issue was NOT a race condition as initially hypothesized, but a **StorageManager URL construction bug**.

**Root Cause**: StorageManager was constructing malformed URLs:
- **Base URL**: `https://dfgzeastcxnoqshgyotp.supabase.co/storage/v1`
- **Constructed**: `{base_url}/storage/v1/object/{bucket}/{key}`
- **Result**: `https://dfgzeastcxnoqshgyotp.supabase.co/storage/v1/storage/v1/object/...` ‚ùå
- **Fixed**: `https://dfgzeastcxnoqshgyotp.supabase.co/storage/v1/object/...` ‚úÖ

**Commits**:
- `e42fcea`: Race condition fixes (incorrect hypothesis)
- `33c0384`: **CRITICAL FIX** - StorageManager URL construction bug fix

## 5. Hypotheses Ledger

### H1: StorageManager URL Construction Bug ‚úÖ **CONFIRMED**
- **Mechanism**: StorageManager adds duplicate `/storage/v1` in URL construction, causing 404 errors
- **Evidence for**: Direct HTTP access works, StorageManager fails with 404s
- **Evidence against**: None
- **Confidence**: High
- **Status**: **RESOLVED** (commit 33c0384)

### H2: Race Condition Between Job Processing and File Access ‚ùå **REFUTED**
- **Mechanism**: Jobs created before file upload completes, causing timing issues
- **Evidence for**: Initial investigation suggested timing problems
- **Evidence against**: Files exist and are accessible via direct HTTP
- **Confidence**: Low
- **Status**: **REFUTED** - Not the root cause

### H3: File Path Mismatch Between Generated and Actual Paths üîç **INVESTIGATING**
- **Mechanism**: Path generation creates different filenames than what's actually stored
- **Evidence for**: Generated path `a5363e8d_5e4390c2.pdf` vs actual `b8cfa47a_5e4390c2.pdf`
- **Evidence against**: TBD
- **Confidence**: Medium
- **Status**: **INVESTIGATING** - Next priority

### H4: Authentication Issues ‚ùå **REFUTED**
- **Mechanism**: Service role key or authentication problems
- **Evidence for**: None
- **Evidence against**: Direct HTTP with same credentials works
- **Confidence**: Low
- **Status**: **REFUTED**

## 6. Attempts So Far

### Attempt 1: Race Condition Fixes (Commit e42fcea)
- **Trigger**: Initial hypothesis of timing-related race conditions
- **Rationale**: Jobs processed before files accessible
- **Change**: Added file existence checks and retry mechanisms in worker
- **Result**: No improvement - error persisted
- **Ruled out**: Race conditions as primary cause

### Attempt 2: StorageManager URL Fix (Commit 33c0384)
- **Trigger**: Discovery of malformed URLs in StorageManager
- **Rationale**: StorageManager constructing wrong URLs causing 404s
- **Change**: Removed duplicate `/storage/v1` from URL construction
- **Result**: ‚úÖ **SUCCESS** - File access now works
- **Ruled out**: StorageManager URL construction as cause

### Attempt 3: Path Mismatch Investigation (Ongoing)
- **Trigger**: Discovery of different generated vs actual file paths
- **Rationale**: Path generation may have changed since file upload
- **Change**: Investigation only
- **Result**: TBD
- **Ruled out**: Nothing yet

## 7. Root-Cause Analysis

### FROCUS Analysis
**Note**: FROCUS methodology not found in codebase documentation. Using standard RCA approach.

### 5 Whys Analysis
1. **Why** does document processing fail? ‚Üí StorageManager can't access files
2. **Why** can't StorageManager access files? ‚Üí URLs return 404 errors
3. **Why** do URLs return 404? ‚Üí URLs are malformed with duplicate `/storage/v1`
4. **Why** are URLs malformed? ‚Üí StorageManager adds `/storage/v1` to base URL that already contains it
5. **Why** does StorageManager add duplicate path? ‚Üí Code bug in URL construction logic

### Ishikawa (Fishbone) Analysis
- **Code**: StorageManager URL construction bug ‚úÖ **ROOT CAUSE**
- **Config**: Environment variables correct
- **Data**: File data intact and accessible
- **Environment**: Supabase Storage working correctly
- **Dependencies**: httpx client working correctly
- **Runtime/Concurrency**: Not applicable
- **Observability**: Logging revealed the issue

### Fault Tree
```
Document Processing Failure
‚îú‚îÄ‚îÄ StorageManager blob_exists() fails
‚îÇ   ‚îú‚îÄ‚îÄ HTTP 404 response
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Malformed URL construction ‚úÖ
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ File doesn't exist ‚ùå
‚îÇ   ‚îî‚îÄ‚îÄ Authentication failure ‚ùå
‚îî‚îÄ‚îÄ File path mismatch (secondary issue)
    ‚îî‚îÄ‚îÄ Path generation vs actual storage ‚ùì
```

## 8. Next Experiments Plan

### E1: Path Mismatch Investigation (Priority 1)
- **Hypothesis**: Path generation creates different filenames than stored
- **Expected if true**: Generated paths don't match actual file paths
- **Expected if false**: Generated paths match actual file paths
- **Procedure**: Compare `generate_storage_path()` output with actual stored files
- **Rollback**: No changes needed
- **Blast radius**: Investigation only

### E2: File Upload Process Analysis (Priority 2)
- **Hypothesis**: File upload process uses different path generation than job creation
- **Expected if true**: Upload creates files with different paths than job expects
- **Expected if false**: Upload and job creation use same path generation
- **Procedure**: Trace file upload process and compare with job creation
- **Rollback**: No changes needed
- **Blast radius**: Investigation only

### E3: Historical Path Generation Changes (Priority 3)
- **Hypothesis**: Path generation logic changed since file was uploaded
- **Expected if true**: Current path generation differs from historical version
- **Expected if false**: Path generation unchanged
- **Procedure**: Git bisect path generation function changes
- **Rollback**: No changes needed
- **Blast radius**: Investigation only

## 9. Invariants & Assertions

### Critical Invariants
1. **File Accessibility**: Files uploaded to Supabase Storage must be accessible via StorageManager
2. **URL Construction**: StorageManager must construct valid Supabase Storage URLs
3. **Path Consistency**: Generated file paths must match actual stored file paths
4. **Job Processing**: Jobs must only process files that exist and are accessible

### Proposed Assertions
```python
# StorageManager URL construction assertion
assert not storage_endpoint.endswith('/storage/v1/storage/v1/object/')

# File existence assertion
assert await storage.blob_exists(file_path), f"File not accessible: {file_path}"

# Path consistency assertion
assert generated_path == actual_stored_path, f"Path mismatch: {generated_path} != {actual_stored_path}"
```

## 10. Observability Upgrade Tasks

### Logging Enhancements
- **File Access Logging**: Add detailed logs for all file access attempts
- **URL Construction Logging**: Log constructed URLs before HTTP requests
- **Path Generation Logging**: Log generated vs actual file paths
- **Correlation IDs**: Add correlation IDs to track requests across services

### Metrics to Add
- **File Access Success Rate**: `storage_file_access_success_rate`
- **URL Construction Errors**: `storage_url_construction_errors`
- **Path Mismatch Count**: `storage_path_mismatch_count`
- **Job Processing Time**: `job_processing_duration_seconds`

### Dashboards
- **Storage Health Dashboard**: File access success rate, error rates
- **Job Processing Dashboard**: Processing times, failure rates
- **Path Consistency Dashboard**: Generated vs actual path comparisons

## 11. Open Questions & Decisions Log

### Open Questions
1. **Path Generation History**: When did path generation logic change?
2. **File Upload Process**: Does upload process use different path generation?
3. **Production Impact**: Is this issue affecting production environment?

### Decisions Log
- **2025-10-01 03:30 UTC**: Deployed StorageManager URL fix (commit 33c0384)
- **2025-10-01 03:30 UTC**: Prioritized path mismatch investigation
- **2025-10-01 03:30 UTC**: Ruled out race condition hypothesis

## 12. Links & Artifacts

### Investigation Scripts
- `test_storage_manager_debug.py` - StorageManager debugging
- `test_complete_flow_simulation.py` - End-to-end flow testing
- `test_actual_file_access.py` - Direct HTTP access testing
- `test_list_storage_files.py` - Storage enumeration

### Commits
- `e42fcea`: Race condition fixes (incorrect)
- `33c0384`: **StorageManager URL fix (critical)**

### Data Artifacts
- `storage_files_list_20250930_200936.json` - Storage bucket contents
- `storage_manager_test_20250930_200810.json` - StorageManager test results

### Documentation
- `FM027_INVESTIGATION_SUMMARY.md` - Initial investigation summary
- `docs/incidents/fm_027/docs/FRACAS_FM_027_DOCUMENT_PROCESSING_FAILURE.md` - Original FRACAS

---

**Status**: Critical fix deployed, path mismatch investigation ongoing  
**Priority**: P1 - Core functionality restored, secondary issues remain  
**Next Action**: Execute path mismatch investigation experiments

