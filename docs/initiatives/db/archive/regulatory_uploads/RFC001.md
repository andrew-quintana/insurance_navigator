# RFC001: Admin Regulatory Document Management Technical Design

## Document Context
- **Version**: RFC001.md
- **Created**: 2025-01-24
- **References**: PRD001_admin_regulatory_documents.md
- **Project**: Insurance Navigator Platform - Admin Document Management Extension
- **Next Document**: TODO001_admin_regulatory_documents.md

## Overview

This RFC defines the technical architecture for implementing admin regulatory document management capabilities, building upon the requirements established in PRD001. The design leverages 95% of the existing document processing pipeline while adding minimal complexity for role-based access and document type differentiation.

### PRD Requirements Summary
- **Primary Goal**: Enable admin upload and management of regulatory documents
- **Key Functionality**: Admin upload interface, document categorization, cross-document search
- **Integration**: Reuse existing doc-parser → chunker → embedder pipeline
- **Success Metrics**: 50+ docs/hour upload rate, 95% search success, 99.5% processing reliability

## Architecture Overview

### High-Level Design

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   Admin UI      │    │   Regular UI     │    │  Shared Backend │
│                 │    │                 │    │                 │
│ • Upload Form   │────┤ • User Uploads   │────┤ • Auth Service  │
│ • Doc Search    │    │ • Doc Search     │    │ • Upload Router │
│ • Bulk Ops      │    │ • View Results   │    │ • Processing    │
└─────────────────┘    └──────────────────┘    └─────────────────┘
         │                       │                       │
         └───────────────────────┼───────────────────────┘
                                 │
                    ┌─────────────────────────┐
                    │   Document Processing   │
                    │                         │
                    │ ┌─────────────────────┐ │
                    │ │   Upload Handler    │ │──┐
                    │ │  (Modified for Role)│ │  │
                    │ └─────────────────────┘ │  │
                    │ ┌─────────────────────┐ │  │
                    │ │    Doc Parser       │ │◄─┤ 95% Reused
                    │ │   (No Changes)      │ │  │ Existing
                    │ └─────────────────────┘ │  │ Pipeline
                    │ ┌─────────────────────┐ │  │
                    │ │     Chunker         │ │  │
                    │ │   (No Changes)      │ │◄─┤
                    │ └─────────────────────┘ │  │
                    │ ┌─────────────────────┐ │  │
                    │ │     Embedder        │ │  │
                    │ │   (No Changes)      │ │◄─┘
                    │ └─────────────────────┘ │
                    └─────────────────────────┘
                                 │
                    ┌─────────────────────────┐
                    │   Enhanced Database     │
                    │                         │
                    │ • documents (+type)     │
                    │ • document_chunks       │
                    │ • Enhanced RLS Policies │
                    │ • Admin Role Support    │
                    └─────────────────────────┘
```

### Data Flow
1. **Admin Upload**: Admin uploads via enhanced UI → Upload Handler (role check) → Document stored with type='regulatory_document'
2. **Processing**: Same pipeline (doc-parser → chunker → embedder) processes both document types
3. **Search**: Enhanced search endpoints filter by document type and apply appropriate access controls
4. **Access Control**: RLS policies enforce document type-based permissions

## Technical Decisions

### Decision 1: Document Type vs Admin Flag
**Chosen**: Document type enum field (`user_document` | `regulatory_document`)
**Rationale**: 
- Cleaner data model - documents categorized by purpose, not uploader
- Flexible access - admins can upload user docs for testing
- Future extensible - easy to add more document types
- Better search filtering by document purpose

**Alternative Rejected**: Boolean `is_admin_uploaded` flag
**Why Rejected**: Less flexible, doesn't indicate document purpose, harder to extend

### Decision 2: Leverage Existing Pipeline vs New Pipeline
**Chosen**: Extend existing upload-handler, reuse all processing functions
**Rationale**:
- 95% code reuse - only upload-handler needs role detection
- Consistent processing quality across document types
- Lower maintenance overhead
- Proven reliability of existing pipeline

**Alternative Rejected**: Separate admin-specific pipeline
**Why Rejected**: Code duplication, higher maintenance cost, inconsistent processing

### Decision 3: Database Schema Extension
**Chosen**: Extend existing documents table with document_type enum
**Rationale**:
- Maintains single source of truth for all documents
- Enables unified search across document types
- Preserves existing relationships and indexes
- Simpler RLS policy management

**Alternative Rejected**: Separate regulatory_documents table
**Why Rejected**: Data fragmentation, complex cross-table searches, RLS complexity

## Database Design

### Schema Changes

```sql
-- Add document type enum
CREATE TYPE document_type AS ENUM ('user_document', 'regulatory_document');

-- Extend documents table
ALTER TABLE documents.documents 
ADD COLUMN document_type document_type DEFAULT 'user_document',
ADD COLUMN admin_category text, -- federal, state, industry
ADD COLUMN description text,
ADD COLUMN public_access boolean DEFAULT false;

-- Add indexes for performance  
CREATE INDEX idx_documents_type ON documents.documents(document_type);
CREATE INDEX idx_documents_admin_category ON documents.documents(admin_category) 
  WHERE document_type = 'regulatory_document';
```

### RLS Policy Design

```sql
-- Users can access their own user documents
CREATE POLICY "users_own_documents" ON documents.documents
  FOR ALL USING (
    owner = auth.uid() AND 
    document_type = 'user_document'
  );

-- Users can read regulatory documents  
CREATE POLICY "users_read_regulatory" ON documents.documents
  FOR SELECT USING (
    document_type = 'regulatory_document' AND
    (public_access = true OR auth.role() = 'authenticated')
  );

-- Admins have full access to all documents
CREATE POLICY "admins_full_access" ON documents.documents
  FOR ALL USING (
    auth.jwt() ->> 'user_metadata' ->> 'role' = 'admin'
  );

-- Admins can insert regulatory documents
CREATE POLICY "admins_insert_regulatory" ON documents.documents
  FOR INSERT WITH CHECK (
    auth.jwt() ->> 'user_metadata' ->> 'role' = 'admin' AND
    document_type = 'regulatory_document'
  );
```

### Data Migration Strategy

```sql
-- Migration script for existing documents
UPDATE documents.documents 
SET document_type = 'user_document' 
WHERE document_type IS NULL;

-- Verify migration
SELECT document_type, COUNT(*) 
FROM documents.documents 
GROUP BY document_type;
```

## Edge Function Modifications

### Upload Handler Changes (supabase/functions/upload-handler/index.ts)

```typescript
// Enhanced auth check
const authResult = await supabase.auth.getUser(token);
const user = authResult.data.user;
const isAdmin = user?.user_metadata?.role === 'admin';

// Parse upload request
const formData = await req.formData();
const documentType = formData.get('documentType') as string || 'user_document';
const adminCategory = formData.get('adminCategory') as string;
const description = formData.get('description') as string;

// Validate permissions
if (documentType === 'regulatory_document' && !isAdmin) {
  return createResponse({ 
    error: 'Only administrators can upload regulatory documents' 
  }, 403);
}

// Enhanced document creation
const documentData = {
  owner: user.id,
  name: file.name,
  source_path: filePath,
  document_type: documentType,
  admin_category: documentType === 'regulatory_document' ? adminCategory : null,
  description: description || null,
  public_access: documentType === 'regulatory_document'
};
```

### New Admin Search Endpoint (supabase/functions/admin-search/index.ts)

```typescript
serve(async (req: Request) => {
  // Verify admin role
  const { user, error } = await supabase.auth.getUser(token);
  if (error || user?.user_metadata?.role !== 'admin') {
    return new Response('Unauthorized', { status: 401 });
  }

  const { searchTerm, documentType, category } = await req.json();
  
  // Build dynamic query
  let query = supabase
    .schema('documents')
    .from('documents')
    .select('id, name, document_type, admin_category, uploaded_at, processing_status');
  
  if (documentType) {
    query = query.eq('document_type', documentType);
  }
  
  if (category && documentType === 'regulatory_document') {
    query = query.eq('admin_category', category);
  }
  
  if (searchTerm) {
    query = query.ilike('name', `%${searchTerm}%`);
  }
  
  const { data, error } = await query.order('uploaded_at', { ascending: false });
  
  return new Response(JSON.stringify({ documents: data }), {
    headers: { ...corsHeaders, 'Content-Type': 'application/json' }
  });
});
```

## Implementation Plan

### Phase 1: Database and Auth Foundation (Week 1)
1. **Database Migration**
   - Create document_type enum
   - Add columns to documents table
   - Create indexes for performance
   - Migrate existing data

2. **Authentication Enhancement**
   - Define admin role in user metadata
   - Test role detection in edge functions
   - Update RLS policies

3. **Testing Infrastructure**
   - Create admin test users
   - Test role-based access
   - Verify RLS policy enforcement

### Phase 2: Backend Implementation (Week 2-3)
1. **Upload Handler Enhancement**
   - Add role detection logic
   - Support document type parameter
   - Add admin metadata fields
   - Maintain backward compatibility

2. **Admin Search Endpoint**
   - Create new edge function
   - Implement multi-criteria search
   - Add download functionality
   - Test bulk operations support

3. **Integration Testing**
   - Verify existing pipeline compatibility
   - Test mixed document type processing
   - Performance testing with increased load

### Phase 3: Frontend Implementation (Week 4)
1. **Admin Upload Interface**
   - Document type selection
   - Category and description fields
   - Bulk upload support
   - Processing status display

2. **Admin Search Interface**
   - Document type filtering
   - Category-based search
   - Download capabilities
   - Management operations

3. **User Interface Updates**
   - Regulatory document search
   - Document type indicators
   - Access control messaging

## Alternative Approaches Considered

### Alternative 1: Microservice Architecture
**Approach**: Separate service for admin document management
**Pros**: Clean separation, independent scaling
**Cons**: Complexity, data synchronization, deployment overhead
**Decision**: Rejected - Monolithic approach simpler for current scale

### Alternative 2: Event-Driven Processing
**Approach**: Queue-based document processing with event triggers
**Pros**: Better scalability, fault tolerance
**Cons**: Added complexity, debugging difficulty, current pipeline works well
**Decision**: Deferred - Consider for future high-volume scenarios

### Alternative 3: Multi-Tenant Database Design
**Approach**: Separate schemas for user vs regulatory documents
**Pros**: Complete data isolation
**Cons**: Complex queries, RLS complexity, migration challenges
**Decision**: Rejected - Single schema with type differentiation preferred

## Risk Assessment and Mitigation

### Technical Risks

#### Risk 1: Database Migration Impact
**Impact**: High - Could affect existing user uploads
**Probability**: Medium
**Mitigation**: 
- Perform migration during low-traffic period
- Implement rollback procedure
- Test thoroughly in staging environment
- Use database transactions for atomicity

#### Risk 2: RLS Policy Conflicts
**Impact**: High - Could expose unauthorized data
**Probability**: Low
**Mitigation**:
- Comprehensive policy testing with different user types
- Staged rollout of policy changes
- Security audit before production deployment

#### Risk 3: Performance Degradation
**Impact**: Medium - Search performance could degrade with increased documents
**Probability**: Medium
**Mitigation**:
- Implement appropriate database indexes
- Monitor query performance
- Use connection pooling
- Consider caching for frequently accessed documents

### Operational Risks

#### Risk 4: Admin User Management
**Impact**: Medium - Incorrect admin permissions could cause security issues
**Probability**: Low
**Mitigation**:
- Clear admin role assignment procedures
- Audit logging for admin actions
- Regular access reviews

## Testing Strategy

### Unit Testing
- Upload handler role detection logic
- Document type validation
- RLS policy enforcement
- Search query building

### Integration Testing  
- End-to-end document upload flow
- Cross-document type search functionality
- Admin permission enforcement
- Existing pipeline compatibility

### Performance Testing
- Document upload under load
- Search performance with large document sets
- Concurrent admin and user operations
- Database query optimization validation

### Security Testing
- Role-based access control validation
- RLS policy penetration testing
- Admin privilege escalation prevention
- Data exposure prevention

## Performance Considerations

### Database Optimization
- **Indexes**: Strategic indexing on document_type, admin_category, processing_status
- **Partitioning**: Consider table partitioning by document_type for very large datasets
- **Query Optimization**: Use EXPLAIN ANALYZE to optimize search queries

### Edge Function Scaling
- **Connection Pooling**: Implement database connection pooling for high-concurrent access
- **Caching**: Consider Redis caching for frequently accessed regulatory documents
- **Rate Limiting**: Implement upload rate limiting to prevent abuse

### Storage Optimization
- **File Compression**: Consider compression for large regulatory documents
- **CDN Integration**: Use CDN for frequently accessed regulatory documents
- **Cleanup Policies**: Implement archival for old processing logs

## Security Considerations

### Access Control
- **Principle of Least Privilege**: Users can only access their documents + public regulatory
- **Admin Auditing**: Log all admin actions for compliance
- **Token Validation**: Verify JWT tokens on every request

### Data Protection
- **Encryption**: All documents encrypted at rest in Supabase storage
- **Transport Security**: HTTPS enforcement for all API calls
- **Sensitive Data**: Avoid logging sensitive document content

## Monitoring and Observability

### Key Metrics
- Document upload success/failure rates by type
- Processing pipeline performance
- Search query performance
- Admin action frequency and patterns

### Alerting
- Failed document processing
- Unusual admin activity patterns
- Performance threshold breaches
- Security policy violations

## Next Steps

Upon approval of this RFC, the next phase involves creating **TODO001_admin_regulatory_documents.md** which will provide:
- Detailed implementation task breakdown
- Development environment setup instructions
- Testing procedures and checklists
- Deployment steps and rollback procedures
- Documentation and training requirements

**Technical Review Required**: Senior Engineer, Database Administrator, Security Engineer
**Implementation Timeline**: 4 weeks total (following the phased approach outlined)
**Success Criteria**: All PRD acceptance criteria met with performance benchmarks achieved