# RFC001: Patient Navigator Supervisor Workflow - Technical Design (MVP)

## Overview

This RFC defines the technical architecture for implementing the **MVP (Minimum Viable Product)** of the Patient Navigator Supervisor Workflow, building on requirements established in PRD001.md. This is a **proof of concept implementation** that demonstrates full supervisor workflow functionality while focusing on core orchestration patterns that can be extended for production scale.

The supervisor workflow provides intelligent orchestration between workflow prescription and document availability checking to route users through appropriate healthcare access paths, serving as a foundation for more advanced routing capabilities.

**Reference PRD**: [PRD001.md](./PRD001.md)  
**MVP Scope**: Proof of concept with full functionality for information_retrieval and strategy workflows  
**Key Requirements**: Workflow prescription for 2 workflows, deterministic document availability checking, <2 second total execution time  
**Success Metrics**: >90% workflow success rate, >95% routing accuracy, <500ms document checking, 40% reduction in failed executions  
**MVP Goal**: Demonstrate complete supervisor orchestration patterns that can scale to additional workflows

## Architecture Overview

### High-Level System Design (LangGraph Workflow)

```
┌─────────────────┐    ┌──────────────────────┐    ┌─────────────────────┐
│   User Query    │───▶│  LangGraph Supervisor│───▶│  Workflow Execution │
│   + User ID     │    │     Workflow         │    │    (IR/Strategy)    │
└─────────────────┘    └──────────────────────┘    └─────────────────────┘
                                   │
                       ┌───────────▼────────────┐
                       │    LangGraph Nodes     │
                       │                        │
              ┌────────▼─────────┐    ┌────────▼────────┐
              │ Workflow         │    │ Document        │
              │ Prescription     │    │ Availability    │
              │ Node (Agent)     │    │ Check Node      │
              └──────────────────┘    └─────────────────┘
                       │                        │
              ┌────────▼─────────┐    ┌────────▼────────┐
              │ LLM + Few-shot   │    │ Supabase Query  │
              │ Examples         │    │ + Simple Logic  │
              └──────────────────┘    └─────────────────┘
```

### LangGraph Workflow Architecture (MVP Implementation)

**LangGraph Supervisor Workflow**: Orchestrates agent execution and deterministic checks with seamless extensibility  
**Workflow Prescription Node (Agent)**: LLM-based classification using few-shot learning (MVP: information_retrieval + strategy examples)  
**Document Availability Check Node**: Deterministic Supabase document presence verification (MVP: basic document types)  
**Workflow Execution Node**: Integration with existing information_retrieval and strategy workflow components  
**State Management**: LangGraph state handling for workflow context and decision routing

## Technical Decisions

### 1. LangGraph Workflow Architecture Pattern

**Decision**: Implement supervisor as a LangGraph workflow orchestrating a single agent and deterministic check

**Rationale**: 
- Provides structured workflow orchestration with clear node separation
- Enables seamless extension to multiple agents in future iterations
- Leverages LangGraph's state management for workflow context
- Maintains consistency with existing agent patterns while adding workflow capabilities
- **MVP Focus**: Single agent → check pattern proves extensibility for multi-agent workflows

**Implementation**:
```python
from langgraph import Graph, StateGraph
from agents.base_agent import BaseAgent

class SupervisorWorkflow:
    def __init__(self, use_mock: bool = False):
        self.workflow_agent = WorkflowPrescriptionAgent(use_mock=use_mock)
        self.document_checker = DocumentAvailabilityChecker()
        self.graph = self._build_workflow_graph()
    
    def _build_workflow_graph(self) -> StateGraph:
        # LangGraph workflow: Agent → Check → Route
        workflow = StateGraph(SupervisorState)
        workflow.add_node("prescribe_workflow", self._prescribe_workflow_node)
        workflow.add_node("check_documents", self._check_documents_node)
        workflow.add_node("route_decision", self._route_decision_node)
        
        # Sequential flow: prescription → document check → routing
        workflow.add_edge("prescribe_workflow", "check_documents")
        workflow.add_edge("check_documents", "route_decision")
        
        return workflow.compile()
```

### 2. Workflow Prescription Technology (MVP Approach)

**Decision**: LLM-based classification with few-shot learning examples

**Rationale**:
- Provides flexibility for natural language understanding
- Few-shot examples ensure consistent classification patterns
- Enables confidence scoring for prescription accuracy
- Matches patterns from inspiration material
- **MVP Advantage**: Simple 2-workflow classification proves the pattern while being easily extensible

**Implementation**:
- System prompt with workflow classification examples
- Structured Pydantic output with confidence scores
- Fallback logic for edge cases and low-confidence prescriptions

### 3. Document Availability Node Architecture (MVP Implementation)

**Decision**: Deterministic Supabase query-based checking as LangGraph node (not agent-based)

**Rationale**:
- Meets PRD requirement for deterministic checking
- Eliminates LLM costs and latency for simple presence verification
- Provides reliable, fast document availability assessment
- Integrates seamlessly with LangGraph workflow state management
- **MVP Scope**: Basic document types sufficient to prove orchestration patterns

**Implementation**:
```python
async def _check_documents_node(self, state: SupervisorState) -> SupervisorState:
    """LangGraph node for document availability checking"""
    prescribed_workflows = state["prescribed_workflows"]
    user_id = state["user_id"]
    
    # Determine required documents based on prescribed workflows
    required_docs = self._get_required_documents(prescribed_workflows)
    
    # Direct Supabase query without LLM processing
    availability_result = await self.document_checker.check_availability(
        required_docs, user_id
    )
    
    # Update workflow state
    state["document_availability"] = availability_result
    return state
```

### 4. LangGraph State Management & Execution Order

**Decision**: LangGraph state-managed deterministic sequential execution (agent → check → route)

**Rationale**:
- LangGraph state management provides clear workflow context
- Deterministic node sequence ensures consistent execution patterns
- State persistence enables complex routing decisions
- Extensible pattern for adding multiple agents in future iterations

### 5. Integration Patterns with LangGraph

**Decision**: LangGraph workflow integration with existing components using node-based interfaces

**Rationale**:
- LangGraph nodes can integrate with existing `InformationRetrievalAgent.process()` method
- Workflow state enables context passing between nodes and existing components
- Node-based architecture maintains separation of concerns while enabling orchestration
- Extensible pattern for adding more workflow agents as additional nodes

## Alternative Approaches Considered

### 1. Agent-Based Document Checking
**Considered**: Using LLM agent with ReAct methodology for document availability  
**Rejected**: User feedback explicitly requested deterministic checking over agent-based approach  
**Trade-off**: Simpler logic but less intelligent document quality assessment

### 2. Parallel Workflow Execution
**Considered**: Running information_retrieval and strategy workflows in parallel  
**Rejected**: Information retrieval context improves strategy quality when run sequentially  
**Trade-off**: Longer execution time but better strategy outcomes

### 3. Rule-Based Workflow Prescription
**Considered**: Static keyword matching for workflow classification  
**Rejected**: Natural language queries require more sophisticated understanding  
**Trade-off**: LLM costs vs. classification accuracy and flexibility

## MVP Implementation Plan

### Phase 1: Core MVP Architecture (Weeks 1-2)

**Week 1: MVP Foundation Components**
- Implement LangGraph `SupervisorWorkflow` with node-based architecture (MVP: single agent + check pattern)
- Create Pydantic models for workflow state (`SupervisorState`) and input/output schemas
- Build `WorkflowPrescriptionAgent` with few-shot learning system prompt (MVP: information_retrieval + strategy examples)
- Develop `DocumentAvailabilityChecker` with Supabase integration (MVP: core document types)

**Week 2: MVP LangGraph Orchestration Layer**
- Implement LangGraph workflow nodes with deterministic sequencing (MVP: agent → check → route)
- Add error handling and fallback mechanisms in workflow state management
- Create node-based integration interfaces with existing workflow components
- Implement structured workflow output generation and confidence scoring

### Phase 2: MVP Integration & Testing (Weeks 3-4)

**Week 3: MVP Workflow Integration**
- Connect to `InformationRetrievalAgent` and `StrategyWorkflowOrchestrator` (MVP: 2-workflow integration)
- Implement Supabase document table integration with Row Level Security (MVP: basic document queries)
- Add comprehensive error handling and graceful degradation (MVP: core error scenarios)
- Create mock mode for testing without API costs (MVP: development efficiency)

**Week 4: MVP Testing & Validation**
- Build unit tests for all components following existing test patterns (MVP: core functionality coverage)
- Implement integration tests with mock Supabase data (MVP: 2-workflow scenarios)
- Performance testing to meet <2 second execution time target (MVP: baseline performance)
- End-to-end testing with realistic user scenarios (MVP: proof of concept validation)

### Phase 3: MVP Performance & Documentation (Weeks 5-6)

**Week 5: MVP Performance Optimization**
- Optimize document checking queries for <500ms response time (MVP: basic optimization)
- Implement connection pooling and query optimization (MVP: foundational patterns)
- Add monitoring and logging using existing patterns (MVP: essential observability)
- Performance benchmarking and bottleneck identification (MVP: baseline metrics)

**Week 6: MVP Documentation & Review**
- Security review and HIPAA compliance validation (MVP: core requirements)
- Documentation and deployment guides (MVP: extensibility patterns)
- Monitoring dashboards and alerting setup (MVP: essential monitoring)
- Stakeholder review and MVP demonstration (MVP: proof of concept validation)

## Risk Assessment & Mitigation

### Technical Risks

**Risk**: LLM prescription accuracy for edge cases  
**Mitigation**: Comprehensive few-shot examples covering edge cases, fallback to default routing logic  
**Contingency**: Rule-based fallback system for low-confidence prescriptions

**Risk**: Supabase query performance under high load  
**Mitigation**: Query optimization, connection pooling, and caching strategies  
**Contingency**: Document availability caching and rate limiting

**Risk**: Integration compatibility with existing workflows  
**Mitigation**: Follow established patterns from existing agents, comprehensive integration testing  
**Contingency**: Adapter pattern for interface compatibility

### Performance Risks

**Risk**: Exceeding 2-second total execution time target  
**Mitigation**: Parallel document checking, optimized LLM prompts, query optimization  
**Contingency**: Asynchronous processing with immediate response and background completion

**Risk**: High token usage costs for workflow prescription  
**Mitigation**: Optimized prompts, few-shot examples instead of extensive context  
**Contingency**: Hybrid approach with rule-based fallback for common patterns

## Testing Strategy

### Unit Testing
- `WorkflowPrescriptionAgent` with various query types and confidence scoring
- `DocumentAvailabilityChecker` with different document availability scenarios
- `SupervisorWorkflowAgent` orchestration logic and error handling
- Pydantic model validation and serialization

### Integration Testing  
- End-to-end supervisor workflow with mock information_retrieval and strategy components
- Supabase integration with test data and Row Level Security validation
- Error handling and graceful degradation scenarios
- Performance testing with realistic load patterns

### Performance Testing
- Execution time measurement under various load conditions
- Document checking latency optimization and validation
- Memory usage and resource consumption analysis
- Concurrency testing with multiple simultaneous requests

## Performance Considerations

### Scalability Requirements
- **Horizontal Scaling**: Stateless agent design enables load balancing across multiple instances
- **Connection Management**: Supabase connection pooling to handle concurrent document checks
- **Caching Strategy**: Document availability caching for frequently accessed documents
- **Resource Optimization**: Efficient memory usage patterns following existing agent implementations

### Optimization Strategies
- **Parallel Processing**: Document availability checks run concurrently for multiple documents
- **Query Optimization**: Efficient Supabase queries with proper indexing on user_id and document_type
- **Prompt Engineering**: Minimal token usage for workflow prescription while maintaining accuracy
- **Response Caching**: Cache workflow prescriptions for identical or similar queries

## Security & Compliance

### HIPAA Compliance
- **Audit Logging**: Complete logging of all supervisor workflow decisions and document access
- **Access Control**: Integration with existing Supabase Row Level Security for document access
- **Data Minimization**: Only necessary document metadata accessed during availability checking
- **Error Handling**: Secure error messages that don't expose sensitive information

### Authentication & Authorization
- **User Authentication**: Integration with existing user authentication system
- **Document Access**: Respect existing document access permissions and RLS policies
- **API Security**: Secure endpoints following existing API security patterns
- **Token Management**: Secure handling of authentication tokens and API keys

## Monitoring & Observability

### Key Metrics
- **Execution Time**: Total supervisor workflow execution time (target: <2 seconds)
- **Document Check Latency**: Individual document availability check time (target: <500ms)
- **Routing Accuracy**: Percentage of correctly prescribed workflows (target: >95%)
- **Success Rate**: Percentage of workflows completing without document-related failures (target: >90%)

### Alerting & Logging
- **Performance Alerts**: Notifications when execution time exceeds targets
- **Error Tracking**: Comprehensive error logging with structured messages
- **Usage Analytics**: Workflow prescription patterns and document availability trends
- **Health Checks**: Regular health monitoring of all supervisor workflow components

## API Design

### Input Schema
```python
class SupervisorWorkflowInput(BaseModel):
    user_query: str
    user_id: str
    workflow_context: Optional[Dict[str, Any]] = None
```

### Output Schema  
```python
class SupervisorWorkflowOutput(BaseModel):
    routing_decision: Literal["PROCEED", "COLLECT"]
    prescribed_workflows: List[WorkflowType]
    execution_order: List[WorkflowType]
    document_availability: DocumentAvailabilityResult
    workflow_prescription: WorkflowPrescriptionResult
    next_steps: List[str]
    confidence_score: float
    processing_time: float
```

### REST API Endpoints
- `POST /api/supervisor/route` - Main supervisor workflow routing endpoint
- `GET /api/supervisor/health` - Health check endpoint for monitoring
- `POST /api/supervisor/prescription` - Standalone workflow prescription endpoint
- `POST /api/supervisor/documents/check` - Standalone document availability endpoint

## Dependencies & Integration Points

### External Dependencies
- **Anthropic Claude API**: For workflow prescription LLM processing
- **Supabase Database**: For document availability checking and user authentication
- **Existing Patient Navigator Components**: Information retrieval and strategy workflow agents

### Internal Integration Points
- **LangGraph Framework**: Foundation for workflow orchestration and state management
- **BaseAgent Class**: Foundation for workflow prescription agent implementation
- **InformationRetrievalAgent**: Integration for information retrieval workflow execution via LangGraph nodes
- **StrategyWorkflowOrchestrator**: Integration for strategy workflow execution via LangGraph nodes
- **Shared Utilities**: Terminology translation and consistency checking components

## Migration & Deployment

### Deployment Strategy
- **Blue-Green Deployment**: Zero-downtime deployment using existing deployment infrastructure
- **Feature Flags**: Gradual rollout with feature flags for controlled testing
- **Rollback Plan**: Quick rollback capability in case of critical issues
- **Database Migrations**: Schema updates for any new tracking or logging requirements

### Configuration Management
- **Environment Variables**: Configuration for mock mode, API endpoints, and timeouts
- **Secrets Management**: Secure handling of API keys and database credentials
- **Feature Configuration**: Toggles for different components and fallback behaviors
- **Performance Tuning**: Configurable timeouts, retry policies, and resource limits

## Next Steps (MVP Path)

This RFC will be followed by:
1. **TODO001.md**: Detailed MVP implementation task breakdown with specific coding tasks
2. **Stakeholder Review**: Technical review focusing on MVP scope and extensibility patterns  
3. **Architecture Review**: Security and compliance review for MVP HIPAA requirements
4. **MVP Implementation Kickoff**: Sprint planning for proof of concept development
5. **Post-MVP Planning**: Roadmap for extending to additional workflows and production scale

---

**Document Version**: RFC001  
**Created**: 2025-08-05  
**Status**: Draft - Pending Technical Review  
**Previous Document**: PRD001.md - Product Requirements Document  
**Next Document**: TODO001.md - Implementation Task Breakdown