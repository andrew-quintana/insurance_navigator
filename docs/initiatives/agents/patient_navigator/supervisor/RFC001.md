# RFC001: Patient Navigator Supervisor Workflow - Technical Design (MVP)

## Overview

This RFC defines the technical architecture for implementing the **MVP (Minimum Viable Product)** of the Patient Navigator Supervisor Workflow, building on requirements established in PRD001.md. This is a **proof of concept implementation** that demonstrates full supervisor workflow functionality while focusing on core orchestration patterns that can be extended for production scale.

The supervisor workflow provides intelligent orchestration between workflow prescription and document availability checking to route users through appropriate healthcare access paths, serving as a foundation for more advanced routing capabilities.

**Reference PRD**: [PRD001.md](./PRD001.md)  
**MVP Scope**: Proof of concept with full functionality for information_retrieval and strategy workflows  
**Key Requirements**: Workflow prescription for 2 workflows, deterministic document availability checking, <2 second total execution time  
**Success Metrics**: >90% workflow success rate, >95% routing accuracy, <500ms document checking, 40% reduction in failed executions  
**MVP Goal**: Demonstrate complete supervisor orchestration patterns that can scale to additional workflows

## Architecture Overview

### High-Level System Design

```
┌─────────────────┐    ┌──────────────────────┐    ┌─────────────────────┐
│   User Query    │───▶│  Supervisor Workflow │───▶│  Workflow Execution │
│   + User ID     │    │     Orchestrator     │    │    (IR/Strategy)    │
└─────────────────┘    └──────────────────────┘    └─────────────────────┘
                                   │
                       ┌───────────▼────────────┐
                       │                        │
              ┌────────▼─────────┐    ┌────────▼────────┐
              │ Workflow         │    │ Document        │
              │ Prescription     │    │ Availability    │
              │ Agent            │    │ Checker         │
              └──────────────────┘    └─────────────────┘
                       │                        │
              ┌────────▼─────────┐    ┌────────▼────────┐
              │ LLM + Few-shot   │    │ Supabase Query  │
              │ Examples         │    │ + Simple Logic  │
              └──────────────────┘    └─────────────────┘
```

### Component Architecture (MVP Implementation)

**Supervisor Orchestrator**: Main coordination layer following existing patient navigator patterns (MVP: 2 workflows, extensible design)  
**Workflow Prescription Agent**: LLM-based classification using few-shot learning (MVP: information_retrieval + strategy examples)  
**Document Availability Checker**: Deterministic Supabase document presence verification (MVP: basic document types)  
**Integration Layer**: Connects to existing information_retrieval and strategy workflow components (MVP: established interfaces)

## Technical Decisions

### 1. Agent Architecture Pattern

**Decision**: Follow existing patient navigator agent patterns from `/agents/patient_navigator/`

**Rationale**: 
- Maintains consistency with `InformationRetrievalAgent` and `StrategyWorkflowOrchestrator`
- Leverages established `BaseAgent` class and Pydantic model patterns
- Enables seamless integration with existing workflow components
- **MVP Focus**: Demonstrates proven architecture patterns that can scale to additional workflows

**Implementation**:
```python
class SupervisorWorkflowAgent(BaseAgent):
    def __init__(self, use_mock: bool = False, **kwargs):
        super().__init__(
            name="supervisor_workflow",
            prompt="", 
            output_schema=SupervisorWorkflowOutput,
            mock=use_mock,
            **kwargs
        )
```

### 2. Workflow Prescription Technology (MVP Approach)

**Decision**: LLM-based classification with few-shot learning examples

**Rationale**:
- Provides flexibility for natural language understanding
- Few-shot examples ensure consistent classification patterns
- Enables confidence scoring for prescription accuracy
- Matches patterns from inspiration material
- **MVP Advantage**: Simple 2-workflow classification proves the pattern while being easily extensible

**Implementation**:
- System prompt with workflow classification examples
- Structured Pydantic output with confidence scores
- Fallback logic for edge cases and low-confidence prescriptions

### 3. Document Availability Architecture (MVP Implementation)

**Decision**: Deterministic Supabase query-based checking (not agent-based)

**Rationale**:
- Meets PRD requirement for deterministic checking
- Eliminates LLM costs and latency for simple presence verification
- Provides reliable, fast document availability assessment
- Aligns with user feedback to move away from agent-based document checking
- **MVP Scope**: Basic document types sufficient to prove orchestration patterns

**Implementation**:
```python
class DocumentAvailabilityChecker:
    async def check_availability(self, required_docs: List[str], user_id: str) -> DocumentAvailabilityResult:
        # Direct Supabase query without LLM processing
        available_docs = await self._query_supabase_documents(required_docs, user_id)
        return self._generate_availability_result(required_docs, available_docs)
```

### 4. Execution Order Strategy

**Decision**: Deterministic sequential execution (information_retrieval → strategy)

**Rationale**:
- Meets PRD requirement for deterministic ordering
- Information retrieval provides context for strategy workflow
- Simplifies orchestration logic and error handling
- Reduces complexity compared to agent-prescribed ordering

### 5. Integration Patterns

**Decision**: Direct integration with existing workflow components using established interfaces

**Rationale**:
- `InformationRetrievalAgent.process()` method provides consistent interface
- `StrategyWorkflowOrchestrator.execute_workflow()` enables strategy execution
- Maintains separation of concerns and modularity

## Alternative Approaches Considered

### 1. Agent-Based Document Checking
**Considered**: Using LLM agent with ReAct methodology for document availability  
**Rejected**: User feedback explicitly requested deterministic checking over agent-based approach  
**Trade-off**: Simpler logic but less intelligent document quality assessment

### 2. Parallel Workflow Execution
**Considered**: Running information_retrieval and strategy workflows in parallel  
**Rejected**: Information retrieval context improves strategy quality when run sequentially  
**Trade-off**: Longer execution time but better strategy outcomes

### 3. Rule-Based Workflow Prescription
**Considered**: Static keyword matching for workflow classification  
**Rejected**: Natural language queries require more sophisticated understanding  
**Trade-off**: LLM costs vs. classification accuracy and flexibility

## MVP Implementation Plan

### Phase 1: Core MVP Architecture (Weeks 1-2)

**Week 1: MVP Foundation Components**
- Implement `SupervisorWorkflowAgent` following BaseAgent patterns (MVP: 2-workflow focus)
- Create Pydantic models for input/output (`SupervisorWorkflowInput`, `SupervisorWorkflowOutput`)
- Build `WorkflowPrescriptionAgent` with few-shot learning system prompt (MVP: information_retrieval + strategy examples)
- Develop `DocumentAvailabilityChecker` with Supabase integration (MVP: core document types)

**Week 2: MVP Orchestration Layer**
- Implement supervisor orchestration logic with deterministic sequencing (MVP: information_retrieval → strategy)
- Add error handling and fallback mechanisms (MVP: graceful degradation)
- Create integration interfaces with existing workflow components (MVP: established patterns)
- Implement structured output generation and confidence scoring (MVP: proof of concept metrics)

### Phase 2: MVP Integration & Testing (Weeks 3-4)

**Week 3: MVP Workflow Integration**
- Connect to `InformationRetrievalAgent` and `StrategyWorkflowOrchestrator` (MVP: 2-workflow integration)
- Implement Supabase document table integration with Row Level Security (MVP: basic document queries)
- Add comprehensive error handling and graceful degradation (MVP: core error scenarios)
- Create mock mode for testing without API costs (MVP: development efficiency)

**Week 4: MVP Testing & Validation**
- Build unit tests for all components following existing test patterns (MVP: core functionality coverage)
- Implement integration tests with mock Supabase data (MVP: 2-workflow scenarios)
- Performance testing to meet <2 second execution time target (MVP: baseline performance)
- End-to-end testing with realistic user scenarios (MVP: proof of concept validation)

### Phase 3: MVP Performance & Documentation (Weeks 5-6)

**Week 5: MVP Performance Optimization**
- Optimize document checking queries for <500ms response time (MVP: basic optimization)
- Implement connection pooling and query optimization (MVP: foundational patterns)
- Add monitoring and logging using existing patterns (MVP: essential observability)
- Performance benchmarking and bottleneck identification (MVP: baseline metrics)

**Week 6: MVP Documentation & Review**
- Security review and HIPAA compliance validation (MVP: core requirements)
- Documentation and deployment guides (MVP: extensibility patterns)
- Monitoring dashboards and alerting setup (MVP: essential monitoring)
- Stakeholder review and MVP demonstration (MVP: proof of concept validation)

## Risk Assessment & Mitigation

### Technical Risks

**Risk**: LLM prescription accuracy for edge cases  
**Mitigation**: Comprehensive few-shot examples covering edge cases, fallback to default routing logic  
**Contingency**: Rule-based fallback system for low-confidence prescriptions

**Risk**: Supabase query performance under high load  
**Mitigation**: Query optimization, connection pooling, and caching strategies  
**Contingency**: Document availability caching and rate limiting

**Risk**: Integration compatibility with existing workflows  
**Mitigation**: Follow established patterns from existing agents, comprehensive integration testing  
**Contingency**: Adapter pattern for interface compatibility

### Performance Risks

**Risk**: Exceeding 2-second total execution time target  
**Mitigation**: Parallel document checking, optimized LLM prompts, query optimization  
**Contingency**: Asynchronous processing with immediate response and background completion

**Risk**: High token usage costs for workflow prescription  
**Mitigation**: Optimized prompts, few-shot examples instead of extensive context  
**Contingency**: Hybrid approach with rule-based fallback for common patterns

## Testing Strategy

### Unit Testing
- `WorkflowPrescriptionAgent` with various query types and confidence scoring
- `DocumentAvailabilityChecker` with different document availability scenarios
- `SupervisorWorkflowAgent` orchestration logic and error handling
- Pydantic model validation and serialization

### Integration Testing  
- End-to-end supervisor workflow with mock information_retrieval and strategy components
- Supabase integration with test data and Row Level Security validation
- Error handling and graceful degradation scenarios
- Performance testing with realistic load patterns

### Performance Testing
- Execution time measurement under various load conditions
- Document checking latency optimization and validation
- Memory usage and resource consumption analysis
- Concurrency testing with multiple simultaneous requests

## Performance Considerations

### Scalability Requirements
- **Horizontal Scaling**: Stateless agent design enables load balancing across multiple instances
- **Connection Management**: Supabase connection pooling to handle concurrent document checks
- **Caching Strategy**: Document availability caching for frequently accessed documents
- **Resource Optimization**: Efficient memory usage patterns following existing agent implementations

### Optimization Strategies
- **Parallel Processing**: Document availability checks run concurrently for multiple documents
- **Query Optimization**: Efficient Supabase queries with proper indexing on user_id and document_type
- **Prompt Engineering**: Minimal token usage for workflow prescription while maintaining accuracy
- **Response Caching**: Cache workflow prescriptions for identical or similar queries

## Security & Compliance

### HIPAA Compliance
- **Audit Logging**: Complete logging of all supervisor workflow decisions and document access
- **Access Control**: Integration with existing Supabase Row Level Security for document access
- **Data Minimization**: Only necessary document metadata accessed during availability checking
- **Error Handling**: Secure error messages that don't expose sensitive information

### Authentication & Authorization
- **User Authentication**: Integration with existing user authentication system
- **Document Access**: Respect existing document access permissions and RLS policies
- **API Security**: Secure endpoints following existing API security patterns
- **Token Management**: Secure handling of authentication tokens and API keys

## Monitoring & Observability

### Key Metrics
- **Execution Time**: Total supervisor workflow execution time (target: <2 seconds)
- **Document Check Latency**: Individual document availability check time (target: <500ms)
- **Routing Accuracy**: Percentage of correctly prescribed workflows (target: >95%)
- **Success Rate**: Percentage of workflows completing without document-related failures (target: >90%)

### Alerting & Logging
- **Performance Alerts**: Notifications when execution time exceeds targets
- **Error Tracking**: Comprehensive error logging with structured messages
- **Usage Analytics**: Workflow prescription patterns and document availability trends
- **Health Checks**: Regular health monitoring of all supervisor workflow components

## API Design

### Input Schema
```python
class SupervisorWorkflowInput(BaseModel):
    user_query: str
    user_id: str
    workflow_context: Optional[Dict[str, Any]] = None
```

### Output Schema  
```python
class SupervisorWorkflowOutput(BaseModel):
    routing_decision: Literal["PROCEED", "COLLECT"]
    prescribed_workflows: List[WorkflowType]
    execution_order: List[WorkflowType]
    document_availability: DocumentAvailabilityResult
    workflow_prescription: WorkflowPrescriptionResult
    next_steps: List[str]
    confidence_score: float
    processing_time: float
```

### REST API Endpoints
- `POST /api/supervisor/route` - Main supervisor workflow routing endpoint
- `GET /api/supervisor/health` - Health check endpoint for monitoring
- `POST /api/supervisor/prescription` - Standalone workflow prescription endpoint
- `POST /api/supervisor/documents/check` - Standalone document availability endpoint

## Dependencies & Integration Points

### External Dependencies
- **Anthropic Claude API**: For workflow prescription LLM processing
- **Supabase Database**: For document availability checking and user authentication
- **Existing Patient Navigator Components**: Information retrieval and strategy workflow agents

### Internal Integration Points
- **BaseAgent Class**: Foundation for supervisor workflow agent implementation
- **InformationRetrievalAgent**: Integration for information retrieval workflow execution
- **StrategyWorkflowOrchestrator**: Integration for strategy workflow execution
- **Shared Utilities**: Terminology translation and consistency checking components

## Migration & Deployment

### Deployment Strategy
- **Blue-Green Deployment**: Zero-downtime deployment using existing deployment infrastructure
- **Feature Flags**: Gradual rollout with feature flags for controlled testing
- **Rollback Plan**: Quick rollback capability in case of critical issues
- **Database Migrations**: Schema updates for any new tracking or logging requirements

### Configuration Management
- **Environment Variables**: Configuration for mock mode, API endpoints, and timeouts
- **Secrets Management**: Secure handling of API keys and database credentials
- **Feature Configuration**: Toggles for different components and fallback behaviors
- **Performance Tuning**: Configurable timeouts, retry policies, and resource limits

## Next Steps (MVP Path)

This RFC will be followed by:
1. **TODO001.md**: Detailed MVP implementation task breakdown with specific coding tasks
2. **Stakeholder Review**: Technical review focusing on MVP scope and extensibility patterns  
3. **Architecture Review**: Security and compliance review for MVP HIPAA requirements
4. **MVP Implementation Kickoff**: Sprint planning for proof of concept development
5. **Post-MVP Planning**: Roadmap for extending to additional workflows and production scale

---

**Document Version**: RFC001  
**Created**: 2025-08-05  
**Status**: Draft - Pending Technical Review  
**Previous Document**: PRD001.md - Product Requirements Document  
**Next Document**: TODO001.md - Implementation Task Breakdown